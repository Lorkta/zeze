# 任务系统使用手册

[TOC]

## Module - TaskBase.Module

### 设计理念

这是一个Task的Module模块

### 内部数据

#### Tasks配置总表：tasks

```java
ConcurrentHashMap<Long, TaskBase<?>> taskNodes
```

这里存放所有Task的实例表。可以在Runtime过程中通过Task的ID查询到配置表，然后将从TaskBean恢复出TaskBase的具体实例。

#### Tasks的构造函数总表：constructors

```java
ConcurrentHashMap<Integer, Constructor<?>> constructors
```

在Zeze外部的应用程序初始化Module的时候，会把所有的通过继承TaskBase的任务类的构造函数注册进Module内。通过反射实现动态扩展。

### 主要方法

#### 注册所有扩展Task类型

```java
public
    <ExtendedBean extends Bean,
	ExtendedTask extends TaskBase<ExtendedBean>
	> void registerTask(Class<ExtendedTask> extendedTaskClass)
```

在外部扩展组件初始化module后，要事先将扩展的所有Task类给注册进Task内。这个行为要在`loadConfig`之前，否则读取配置的时候`Zeze.TaskBase.Module`还不知道这些扩展的类的构造函数。

#### 加载配置

```java
void loadConfig(String taskConfigFile)
```

指定一个配置表加载任务配表。（目前支持读取csv的配置表）

## Abstract Class - TaskBase<ExtendedBean extends Bean>

### 设计理念

`TaskBase`是一个所有**<u>具体任务类型</u>**的抽象任务表。任何使用Zeze的应用程序（如：游戏服务器）通过继承`TaskBase`，并且指定自定义扩展的`ExtendedBean`来实现一个具体的任务类型。

`TaskBase`的设计目标是足够抽象，但也不要将功能过于简化。

### TaskBase内部数据

#### 位于数据库的持久数据：BTask

TaskBase含有一部分基础的BTask数据，被认为是通常所有任务都必须具备的。

| Bean数据                | 功能                                                         | 数据类型                |
| ----------------------- | ------------------------------------------------------------ | ----------------------- |
| **roleId**              | 当前任务所属的角色Id，角色注册之后才会初始化。有了roleId就可以给ta派奖励等等。 | `long`                  |
| **taskId**              | 任务ID。UNIQUE KEY。由用户配置表提供指定。                   | `long`                  |
| **taskType**            | 任务类型。TaskBase将内置一部分（目前内置`DailyTask`），但也支持外部扩展。 | `string`                |
| **taskState**           | 任务状态。`不可接取`/`可接取`/`已接取未完成`/`已完成未提交`/`已提交（获得奖励）`。 | `int(enum)`             |
| **taskName**            | 任务名。                                                     | `string`                |
| **taskDescription**     | 任务描述。                                                   | `string`                |
| **preTaskIds**          | 前置的任务ID。（通过提供前置任务Id就可以建立整张TaskGraphics，动态扩展起来也方便） | `list<long>`            |
| **currentPhaseId**      | 当前的任务子流程ID。                                         | `long`                  |
| **taskPhases**          | 所有任务子流程表。                                           | `map<long, BTaskPhase>` |
| **<u>extendedData</u>** | 扩展Bean，由ExtendedBean泛型直接指定。                       | `dynamic`               |

但是，BTask只是需要被存进数据库中的数据，并不是所有TaskBase所有的属性。

#### 位于内存的非持久数据：Runtime Data

| Runtime数据      | 功能                                   | 数据类型                        |
| ---------------- | -------------------------------------- | ------------------------------- |
| **preTaskIds**   | 前置的所有任务ID。<u>Runtime只读。</u> | final `ConcurrentHashSet<Long>` |
| **nextTaskIds**  | 后置的所有任务ID。<u>Runtime只读。</u> | final `ConcurrentHashSet<Long>` |
| **currentPhase** | 当前子流程的类实例。                   | `TaskPhase`                     |

在任务初始化时（比如服务器启动时/通过Bean恢复TaskBase实例时），TaskBase将自动计算这些RuntimeData。

### 实现功能

#### Runtime方法

## 快速上手

### 一个实际的任务开发场景

模拟一个任务开发的具体场景，来看如何实际对任务系统进行再开发和使用。

#### 目标

新建一个任务，任务共分为三个大流程。

流程一：

> 1. 找NPC（id = 1001）对话接任务，其中有一个【带选项的对话】，有两个可供选择的选项，通过玩家不同的选择会触发不同的任务流程。
> 2. 如果选择选项一，跳到流程二。如果选择了选项二，跳到流程三。

流程二：

> 1. 去往任务指定场景位置（3920, 1850）
> 2. （此时在那里刷出任务专属怪）击杀五只怪物（id=2001），并获得5份怪物材料（id=3001）
> 3. 找NPC（id=1002）对话提交5份怪物材料。
> 4. 对话结束，完成任务

流程三：

> 1. 找NPC（id=1003）对话，获得任务道具（id=4001）。
> 2. 去往指定场景位置（3920, 1850）

针对这个目标，我们可以列出相应的配置表

```json

```

