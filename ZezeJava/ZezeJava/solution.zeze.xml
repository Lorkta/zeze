<?xml version="1.0" encoding="utf-8"?>

<solution name="Zeze" ModuleIdAllowRanges="11000-12000">
	<module name="Beans" id="11000">
		<module name="GlobalCacheManagerWithRaft" id="11001">
			<!-- table -->
			<bean name="CacheState" kind="rocks">
				<variable id="1" name="AcquireStatePending" type="int" transient="true"/>
				<variable id="2" name="GlobalSerialId" type="long" transient="true"/>
				<variable id="3" name="Modify" type="int" default="-1"/> ServerId, default MUST BE -1.
				<variable id="4" name="Share" type="set" value="int"/>
			</bean>

			<bean name="AcquiredState" kind="rocks">
				<variable id="1" name="State" type="int"/>
			</bean>

			<table name="Global" key="GlobalTableKey" value="CacheState" kind="rocks" />
			<table name="Session" key="GlobalTableKey" value="AcquiredState" kind="rocks" />

			<!-- rpc -->
			<beankey name="GlobalTableKey">
				<variable id="1" name="TableName" type="string"/>
				<variable id="2" name="Key" type="binary"/>
			</beankey>

			<bean name="AcquireParam">
				<variable id="1" name="GlobalTableKey" type="GlobalTableKey"/>
				<variable id="2" name="State" type="int"/>
			</bean>

			<bean name="ReduceParam">
				<variable id="1" name="GlobalTableKey" type="GlobalTableKey"/>
				<variable id="2" name="State" type="int"/>
				<variable id="3" name="GlobalSerialId" type="long"/>
			</bean>

			<bean name="LoginParam">
				<variable id="1" name="ServerId" type="int"/>
				<variable id="2" name="GlobalCacheManagerHashIndex" type="int"/>
			</bean>

			<bean name="AchillesHeel">
				<variable id="1" name="ServerId" type="int"/>
				<variable id="2" name="SecureKey" type="string"/>
				<variable id="3" name="GlobalCacheManagerHashIndex" type="int"/>
			</bean>

			<rpc name="Acquire" argument="AcquireParam" result="ReduceParam" base="Zeze.Raft.RaftRpc" handle="server" />
			<rpc name="Reduce" argument="ReduceParam" result="ReduceParam" base="Zeze.Raft.RaftRpc" handle="client" />
			<rpc name="Login" argument="LoginParam" base="Zeze.Raft.RaftRpc" handle="server" />
			<rpc name="ReLogin" argument="LoginParam" base="Zeze.Raft.RaftRpc" handle="server" />
			<rpc name="NormalClose" handle="server" base="Zeze.Raft.RaftRpc" />
			<rpc name="Cleanup" argument="AchillesHeel" base="Zeze.Raft.RaftRpc" handle="server" />
			<rpc name="KeepAlive" base="Zeze.Raft.RaftRpc" handle="server" />
		</module>

		<module name="TestRocks" id="11002">
			<bean name="Value" kind="rocks">
				<variable id="1" name="Int" type="int"/>
				<variable id="2" name="Bool" type="bool"/>
				<variable id="3" name="Float" type="float"/>
				<variable id="4" name="double" type="double"/>
				<variable id="5" name="String" type="string"/>
				<variable id="6" name="Binary" type="binary"/>
				<variable id="7" name="SetInt" type="set" value="int"/>
				<variable id="8" name="SetBeankey" type="set" value="Zeze.Beans.GlobalCacheManagerWithRaft.GlobalTableKey"/>
				<variable id="9" name="MapInt" type="map" key="int" value="int"/>
				<variable id="10" name="MapBean" type="map" key="int" value="Value"/>
				<variable id="11" name="Beankey" type="Zeze.Beans.GlobalCacheManagerWithRaft.GlobalTableKey"/>
			</bean>

			<table name="tRocks" key="int" value="Value" kind="rocks"/>
		</module>

		<module name="AutoKey" id="11003">
			<bean name="BAutoKey">
				<variable id="1" name="NextId" type="long"/>
			</bean>
			<table name="tAutoKeys" key="string" value="BAutoKey" />
		</module>

		<module name="Collections" id="11004">
			<module name="LinkedMap" id="11005">
				<bean name="BLinkedMap">
					<variable id="1" name="HeadNodeId" type="long" />
					<variable id="2" name="TailNodeId" type="long" />
					<variable id="3" name="Count" type="long" />
					<variable id="4" name="LastNodeId" type="long" />
				</bean>
				<table name="tLinkedMaps" key="string" value="BLinkedMap" /> key: LinkedMap的Name

				<beankey name="BLinkedMapKey">
					<variable id="1" name="Name" type="string" /> LinkedMap的Name
					<variable id="2" name="ValueId" type="string" /> LinkedMap的Key转成字符串类型
				</beankey>
				<bean name="BLinkedMapNodeId">
					<variable id="1" name="NodeId" type="long" /> KeyValue对所属的节点ID. 每个节点有多个KeyValue对共享
				</bean>
				<table name="tValueIdToNodeId" key="BLinkedMapKey" value="BLinkedMapNodeId" />

				<bean name="BLinkedMapNodeValue">
					<variable id="1" name="Id" type="string" /> LinkedMap的Key转成字符串类型
					<variable id="2" name="Value" type="dynamic">
						<GetSpecialTypeIdFromBean value="Zeze.Collections.LinkedMap::GetSpecialTypeIdFromBean"/>
						<CreateBeanFromSpecialTypeId value="Zeze.Collections.LinkedMap::CreateBeanFromSpecialTypeId"/>
					</variable>
				</bean>
				<beankey name="BLinkedMapNodeKey">
					<variable id="1" name="Name" type="string" /> LinkedMap的Name
					<variable id="2" name="NodeId" type="long" />
				</beankey>
				<bean name="BLinkedMapNode"> 一个节点可以存多个KeyValue对，
					<variable id="1" name="PrevNodeId" type="long" /> 前一个节点ID. 0表示已到达开头。
					<variable id="2" name="NextNodeId" type="long" /> 后一个节点ID. 0表示已到达结尾。
					<variable id="3" name="Values" type="list" value="BLinkedMapNodeValue" /> 多个KeyValue对,容量由LinkedMap构造时的nodeSize决定
				</bean>
				<table name="tLinkedMapNodes" key="BLinkedMapNodeKey" value="BLinkedMapNode"/>
			</module>

			<module name="Queue" id="11006">
				<!--
				1. 单向链表。2. Value没有索引。3. 每个Value记录加入的时间。4. 只能从Head提取，从Tail添加。
				第一个用户是Table.GC，延迟删除记录。
				-->
				<bean name="BQueue">
					<variable id="1" name="HeadNodeId" type="long" />
					<variable id="2" name="TailNodeId" type="long" />
					<variable id="3" name="Count" type="long" />
					<variable id="4" name="LastNodeId" type="long" />
				</bean>
				<table name="tQueues" key="string" value="BQueue" /> key: Queue的Name

				<bean name="BQueueNodeValue">
					<variable id="1" name="Timestamp" type="long" />
					<variable id="2" name="Value" type="dynamic">
						<GetSpecialTypeIdFromBean value="Zeze.Collections.Queue::GetSpecialTypeIdFromBean"/>
						<CreateBeanFromSpecialTypeId value="Zeze.Collections.Queue::CreateBeanFromSpecialTypeId"/>
					</variable>
				</bean>
				<beankey name="BQueueNodeKey">
					<variable id="1" name="Name" type="string" /> LinkedMap的Name
					<variable id="2" name="NodeId" type="long" />
				</beankey>
				<bean name="BQueueNode"> 一个节点可以存多个KeyValue对，
					<variable id="1" name="NextNodeId" type="long" /> 后一个节点ID. 0表示已到达结尾。
					<variable id="2" name="Values" type="list" value="BQueueNodeValue" />
				</bean>
				<table name="tQueueNodes" key="BQueueNodeKey" value="BQueueNode"/>
			</module>
		</module>
		<module name="GCTable" id="11007">
			<bean name="BTableKey">
				<variable id="1" name="TableName" type="string" />
				<variable id="2" name="EncodedKey" type="binary" />
			</bean>
		</module>
	</module>

	<component name="GCTable" gendir="src/main/java" platform="zeze+java">
		<service name="" handle="server">
			<module ref="Zeze.Beans.GCTable"/>
		</service>
	</component>

	<component name="Queue" gendir="src/main/java" genrelativedir="Zeze/Collections" platform="zeze+java">
		<service name="" handle="server">
			<module ref="Zeze.Beans.Collections.Queue"/>
		</service>
	</component>

	<component name="LinkedMap" gendir="src/main/java" genrelativedir="Zeze/Collections" platform="zeze+java">
		<service name="" handle="server">
			<module ref="Zeze.Beans.Collections.LinkedMap"/>
		</service>
	</component>

	<component name="AutoKey" gendir="src/main/java" platform="zeze+java">
		<service name="" handle="server">
			<module ref="Zeze.Beans.AutoKey"/>
		</service>
	</component>

	<component name="GlobalCacheManagerWithRaft" gendir="src/main/java" genrelativedir="Zeze/Services" platform="zeze+java">
		<service name="" handle="server">
			<module ref="Zeze.Beans.GlobalCacheManagerWithRaft"/>
		</service>
	</component>

	<component name="GlobalCacheManagerWithRaftAgent" gendir="src/main/java" genrelativedir="Zeze/Services" platform="zeze+java" GenTables="client">
		<service name="" handle="client">
			<module ref="Zeze.Beans.GlobalCacheManagerWithRaft"/>
		</service>
	</component>

	<component name="TestRocks" gendir="src/main/java" genrelativedir="Zeze/Services" platform="zeze+java">
		<service name="" handle="server">
			<module ref="Zeze.Beans.TestRocks"/>
		</service>
	</component>

</solution>
